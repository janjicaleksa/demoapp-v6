<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Easy Tables - Simplified AI Processor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#1E40AF',
                        accent: '#10B981'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900 mb-2">Easy Tables</h1>
            <h2 class="text-2xl font-semibold text-primary mb-4">Simplified AI Processor</h2>
            <p class="text-gray-600">Process financial documents with parameter-based organization</p>
        </div>

        <!-- Main Content -->
        <div class="max-w-4xl mx-auto">
            <!-- Step 1: Client Creation -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h3 class="text-xl font-semibold text-gray-900 mb-4">Step 1: Create Client</h3>
                <form id="clientForm" class="space-y-4">
                    <div>
                        <label for="clientName" class="block text-sm font-medium text-gray-700 mb-2">Client Name</label>
                        <input type="text" id="clientName" name="clientName" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                               placeholder="Enter client name">
                    </div>
                    <button type="submit" 
                            class="w-full bg-primary text-white py-2 px-4 rounded-md hover:bg-secondary transition-colors">
                        Create Client
                    </button>
                </form>
                <div id="clientResult" class="mt-4 hidden"></div>
            </div>

            <!-- Step 2: Upload Mode Selection -->
            <div id="uploadSection" class="hidden">
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h3 class="text-xl font-semibold text-gray-900 mb-4">Step 2: Choose Upload Mode</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button id="singleModeBtn" 
                                class="p-4 border-2 border-gray-300 rounded-lg hover:border-primary hover:bg-blue-50 transition-colors text-center">
                            <h4 class="text-lg font-semibold text-gray-900 mb-2">Single File Mode</h4>
                            <p class="text-gray-600">Upload and process one file at a time</p>
                        </button>
                        
                        <button id="batchModeBtn"
                                class="p-4 border-2 border-gray-300 rounded-lg hover:border-primary hover:bg-blue-50 transition-colors text-center">
                            <h4 class="text-lg font-semibold text-gray-900 mb-2">Batch Mode</h4>
                            <p class="text-gray-600">Upload multiple files at once</p>
                        </button>
                    </div>
                </div>

                <!-- Single File Upload -->
                <div id="singleUploadSection" class="bg-white rounded-lg shadow-md p-6 mb-6 hidden">
                    <h3 class="text-xl font-semibold text-gray-900 mb-4">Single File Upload</h3>
                    <form id="singleFileForm" class="space-y-4">
                        <input type="hidden" id="clientSlugSingle" name="clientSlug">
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="fileType" class="block text-sm font-medium text-gray-700 mb-2">File Type *</label>
                                <select id="fileType" name="fileType" required
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                    <option value="">Select file type</option>
                                    <option value="kupci">Kupci</option>
                                    <option value="dobavljaci">Dobavljaci</option>
                                </select>
                            </div>
                            
                            <div>
                                <label for="period" class="block text-sm font-medium text-gray-700 mb-2">Period *</label>
                                <select id="period" name="period" required
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                    <option value="">Select period</option>
                                    <option value="prethodna_fiskalna_godina">Prethodna Fiskalna Godina</option>
                                    <option value="presek_bilansa_tekuca_godina">Presek Bilansa Tekuća Godina</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="ivOption" class="hidden">
                            <label class="flex items-center">
                                <input type="checkbox" id="isIv" name="isIv"
                                       class="mr-2 text-primary focus:ring-primary">
                                <span class="text-sm font-medium text-gray-700">Ispravka Vrednosti (IV)</span>
                            </label>
                        </div>
                        
                        <div>
                            <label for="singleFile" class="block text-sm font-medium text-gray-700 mb-2">Select File *</label>
                            <input type="file" id="singleFile" name="file" accept=".xlsx,.csv,.doc,.docx,.pdf" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        
                        <button type="submit" 
                                class="w-full bg-accent text-white py-3 px-4 rounded-md hover:bg-green-700 transition-colors text-lg font-semibold">
                            Process File
                        </button>
                    </form>
                    <div id="singleResult" class="mt-4 hidden"></div>
                </div>

                <!-- Batch Upload -->
                <div id="batchUploadSection" class="bg-white rounded-lg shadow-md p-6 mb-6 hidden">
                    <h3 class="text-xl font-semibold text-gray-900 mb-4">Batch File Upload</h3>
                    <form id="batchForm" class="space-y-6">
                        <input type="hidden" id="clientSlugBatch" name="clientSlug">
                        
                        <!-- Prethodna Fiskalna Godina Section -->
                        <div class="border rounded-lg p-4">
                            <h4 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
                                <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium mr-3">Prethodna Fiskalna Godina</span>
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Kupci</label>
                                    <input type="file" name="kupci_prethodna" accept=".xlsx,.csv,.doc,.docx,.pdf"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Dobavljaci</label>
                                    <input type="file" name="dobavljaci_prethodna" accept=".xlsx,.csv,.doc,.docx,.pdf"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                </div>
                            </div>
                            <div class="mt-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Kupci IV (Optional)</label>
                                <input type="file" name="kupci_prethodna_iv" accept=".xlsx,.csv,.doc,.docx,.pdf"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                            </div>
                        </div>

                        <!-- Presek Bilansa Section -->
                        <div class="border rounded-lg p-4">
                            <h4 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
                                <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium mr-3">Presek Bilansa Tekuća Godina</span>
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Kupci</label>
                                    <input type="file" name="kupci_presek" accept=".xlsx,.csv,.doc,.docx,.pdf"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Dobavljaci</label>
                                    <input type="file" name="dobavljaci_presek" accept=".xlsx,.csv,.doc,.docx,.pdf"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                </div>
                            </div>
                            <div class="mt-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Kupci IV (Optional)</label>
                                <input type="file" name="kupci_presek_iv" accept=".xlsx,.csv,.doc,.docx,.pdf"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                            </div>
                        </div>

                        <button type="submit" 
                                class="w-full bg-accent text-white py-4 px-6 rounded-md hover:bg-green-700 transition-colors text-lg font-semibold">
                            Process All Files
                        </button>
                    </form>
                    <div id="batchResult" class="mt-4 hidden"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Client creation
        document.getElementById('clientForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData();
            formData.append('client_name', document.getElementById('clientName').value);

            try {
                const response = await fetch('/api/clients', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                const resultDiv = document.getElementById('clientResult');
                resultDiv.className = 'mt-4 p-4 rounded-md';
                
                if (response.ok) {
                    resultDiv.className += ' bg-green-100 text-green-800';
                    resultDiv.innerHTML = `
                        <p><strong>Success:</strong> ${result.message}</p>
                        <p><strong>Client Slug:</strong> ${result.client_slug}</p>
                    `;
                    
                    // Store client slug and show upload section
                    document.getElementById('clientSlugSingle').value = result.client_slug;
                    document.getElementById('clientSlugBatch').value = result.client_slug;
                    document.getElementById('uploadSection').classList.remove('hidden');
                } else {
                    resultDiv.className += ' bg-red-100 text-red-800';
                    resultDiv.innerHTML = `<p><strong>Error:</strong> ${result.detail}</p>`;
                }
                resultDiv.classList.remove('hidden');
            } catch (error) {
                console.error('Error:', error);
            }
        });

        // Upload mode selection
        document.getElementById('singleModeBtn').addEventListener('click', () => {
            document.getElementById('singleUploadSection').classList.remove('hidden');
            document.getElementById('batchUploadSection').classList.add('hidden');
            document.getElementById('singleModeBtn').classList.add('border-primary', 'bg-blue-50');
            document.getElementById('batchModeBtn').classList.remove('border-primary', 'bg-blue-50');
        });

        document.getElementById('batchModeBtn').addEventListener('click', () => {
            document.getElementById('batchUploadSection').classList.remove('hidden');
            document.getElementById('singleUploadSection').classList.add('hidden');
            document.getElementById('batchModeBtn').classList.add('border-primary', 'bg-blue-50');
            document.getElementById('singleModeBtn').classList.remove('border-primary', 'bg-blue-50');
        });

        // Show IV option only for kupci
        document.getElementById('fileType').addEventListener('change', (e) => {
            const ivOption = document.getElementById('ivOption');
            if (e.target.value === 'kupci') {
                ivOption.classList.remove('hidden');
            } else {
                ivOption.classList.add('hidden');
                document.getElementById('isIv').checked = false;
            }
        });

        // Single file form submission
        document.getElementById('singleFileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData();
            
            formData.append('client_slug', document.getElementById('clientSlugSingle').value);
            formData.append('file_type', document.getElementById('fileType').value);
            formData.append('period', document.getElementById('period').value);
            formData.append('is_iv', document.getElementById('isIv').checked);
            formData.append('file', document.getElementById('singleFile').files[0]);

            try {
                const response = await fetch('/api/upload/process', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                const resultDiv = document.getElementById('singleResult');
                resultDiv.className = 'mt-4 p-4 rounded-md';
                
                if (response.ok) {
                    resultDiv.className += ' bg-green-100 text-green-800';
                    let html = `<p><strong>Success:</strong> ${result.message}</p>`;
                    
                    if (result.results && result.results.length > 0) {
                        const fileResult = result.results[0];
                        html += `<p><strong>Processed:</strong> ${fileResult.records_processed} records</p>`;
                    }
                    
                    if (result.ai_results && result.ai_results.length > 0) {
                        const aiResult = result.ai_results[0];
                        html += `<p><strong>Date:</strong> ${aiResult.datum}</p>`;
                        html += `<p><strong>Records in table:</strong> ${aiResult.tabela.length}</p>`;
                    }
                    
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.className += ' bg-red-100 text-red-800';
                    resultDiv.innerHTML = `<p><strong>Error:</strong> ${result.detail}</p>`;
                }
                resultDiv.classList.remove('hidden');
            } catch (error) {
                console.error('Error:', error);
            }
        });

        // Batch form submission
        document.getElementById('batchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData();
            
            formData.append('client_slug', document.getElementById('clientSlugBatch').value);
            
            // Add all files
            const fileInputs = [
                'kupci_prethodna', 'dobavljaci_prethodna', 'kupci_prethodna_iv',
                'kupci_presek', 'dobavljaci_presek', 'kupci_presek_iv'
            ];
            
            fileInputs.forEach(inputName => {
                const input = document.querySelector(`input[name="${inputName}"]`);
                if (input.files[0]) {
                    formData.append(inputName, input.files[0]);
                }
            });

            try {
                const response = await fetch('/api/upload/batch', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                const resultDiv = document.getElementById('batchResult');
                resultDiv.className = 'mt-4 p-4 rounded-md';
                
                if (response.ok) {
                    resultDiv.className += ' bg-green-100 text-green-800';
                    let html = `<p><strong>Success:</strong> ${result.message}</p>`;
                    
                    if (result.results && result.results.length > 0) {
                        html += '<h4 class="font-semibold mt-2">Processed Files:</h4><ul class="list-disc list-inside">';
                        result.results.forEach(file => {
                            html += `<li><strong>${file.file_type} (${file.period}):</strong> ${file.records_processed} records processed</li>`;
                        });
                        html += '</ul>';
                    }
                    
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.className += ' bg-red-100 text-red-800';
                    resultDiv.innerHTML = `<p><strong>Error:</strong> ${result.detail}</p>`;
                }
                resultDiv.classList.remove('hidden');
            } catch (error) {
                console.error('Error:', error);
            }
        });
    </script>
</body>
</html>